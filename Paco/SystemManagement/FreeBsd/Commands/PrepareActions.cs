using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using Paco.Entities.FreeBsd;
using Renci.SshNet;
using Sentry.Extensibility;

namespace Paco.SystemManagement.FreeBsd.Commands
{
    public static class PrepareActions
    {
        public static void PreparePackageActions(SshClient client, IEnumerable<object> actions)
        {
            var optionsVersionKey = "_OPTIONS_READ";
            var listOfOptionsKey = "_FILE_COMPLETE_OPTIONS_LIST";

            var setKey = "OPTIONS_FILE_SET";
            var unsetKey = "OPTIONS_FILE_UNSET";
            
            foreach (PackageAction action in actions)
            {
                var builder = new StringBuilder();

                builder
                    .AppendLine("# This file was generated by Paco")
                    .AppendLine($"# Options for {action.NewVersion}")
                    .AppendLine($"{optionsVersionKey}={action.NewVersion}")
                    .AppendLine($"{listOfOptionsKey}={string.Join(" ", action.SimpleOptions.Select(x => x.Name))}");
                
                foreach (var option in action.AllOptions)
                {
                    builder.AppendLine($"{(OptionSetStatus.Set.HasFlag(option.Status) ? setKey : unsetKey)}+={option.Name}");
                }

                var optionsFile = $"{action.DbRoot}/options";

                var newOptions = builder.ToString().Replace("\r", "");

                var createOptionsFileCommand = $"echo $'{newOptions}' | sudo tee {optionsFile} > /dev/null ; echo -n $?";
                var createOptionsFolder = $"sudo /bin/mkdir -p {action.DbRoot}";

                client.CreateCommand(createOptionsFolder).Execute();
                
                var result = client.CreateCommand(createOptionsFileCommand).Execute();

                if (result != "0")
                {
                    throw new IOException($"Could not write to file ({result}).\n{optionsFile} ");
                }
            }
        }
    }
}