@using Microsoft.AspNetCore.Identity
@using Paco.Data.Entities
@using Paco.Data.Entities.Identity
@using Paco.DatabaseRepositories
@using Paco.Services
@using Ancestor.Extensions
@inject ApplicationDbContext ApplicationDbContext
@inject SystemManagerService ManagerService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<User> UserManager

@page "/systems/list"
<h1>Maaged systems</h1>
<table class="table">
    <thead>
        <tr>
            <th>Name</th>
            <th>Hostname</th>
            <th>Last Accessed</th>
            <th>Updates fetched at</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var system in _systems)
        {
            var background = "";
            if (system.NeedsInteraction)
            {
                background = "background: linear-gradient(90deg, rgba(255,255,0,0.25) 0%, rgba(255,255,0,0.5) 100%);";
            }

            <tr @onclick="() => ToggleSystemDetail(system)" style='cursor: pointer; @background'>
                <td>
                    @system.Name
                </td>
                <td>
                    @system.Hostname
                </td>
                <td>
                    @system.LastAccessed
                </td>
                <td>
                    @(system.UpdatesFetchedAt?.ToString() ?? "Never")
                </td>
            </tr>
            @if (ShouldShowDetailForSystem(system))
            {
                <tr role="row" class="b-table-details">
                    <td colspan="4" class="">
                        <div class="card">
                            <div class="card-body">
                                @if (system.SystemInformation == null)
                                {
                                    RefreshSystemInformation(system);
                                }
                                else
                                {
                                    var information = system.SystemInformation.FromJson<Dictionary<string, string>>();
                                    if (information != null)
                                    {
                                        @foreach (var entry in information)
                                        {
                                            <div class="row mb-2">
                                                <div class="text-sm-right col-sm-3"><b>@entry.Key:</b></div>
                                                <div class="col">
                                                    <p style="white-space: pre-line">@entry.Value</p>
                                                </div>
                                            </div>
                                        }
                                    }
                                }
s
                                <button type="button" class="btn btn-dark" @onclick="() => HideDetail(system)">Hide Details</button>
                                <button type="button" class="btn btn-dark" @onclick="() => RefreshSystemInformation(system)">Refresh</button>
                                <button type="button" class="btn btn-dark" @onclick="() => FetchSystemUpdates(system)">Fetch updates</button>
                            </div>
                        </div>
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

@code {
    private List<ManagedSystem> _systems = new List<ManagedSystem>();
    private readonly List<ManagedSystem> _systemsWithDetailOpened = new List<ManagedSystem>();

    protected override async Task OnInitializedAsync()
    {
        var user = await UserManager.GetUserAsync((await AuthenticationStateProvider.GetAuthenticationStateAsync()).User);

        _systems = ApplicationDbContext.ManagedSystems.GetManagedSystemsForUser(user);

        await base.OnInitializedAsync();
    }

    private bool ShouldShowDetailForSystem(ManagedSystem system)
    {
        return _systemsWithDetailOpened.Contains(system);
    }

    private void HideDetail(ManagedSystem system)
    {
        _systemsWithDetailOpened.Remove(system);
    }

    private void ToggleSystemDetail(ManagedSystem system)
    {
        if (!_systemsWithDetailOpened.Contains(system))
        {
            _systemsWithDetailOpened.Add(system);
        }
        else
        {
            _systemsWithDetailOpened.Remove(system);
        }
    }

    private void RefreshSystemInformation(ManagedSystem system)
    {
        Task.Run(() =>
        {
            ManagerService.RefreshSystemInformation(system);
            base.InvokeAsync(() =>
            {
                base.StateHasChanged();
            });
        });
    }

    private void FetchSystemUpdates(ManagedSystem system)
    {
        Task.Run(() =>
        {
            ManagerService.FetchSystemUpdates(system);
            base.InvokeAsync(() =>
            {
                base.StateHasChanged();
            });
        });
    }
}